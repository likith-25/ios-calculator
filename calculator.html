<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>iOS Calculator</title>
  <link rel="stylesheet" href="calculator.css">
  <link rel="icon" type="image/png" href="images/icons8-calculator-48.png">
  <script src="script.js" defer></script>
  <script type="module">

    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
    import { getAuth, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js';
    import { getDatabase, ref, set, push, get, child } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js'; // Realtime Database methods


    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCpqwy9By3CeM_U_zx2B_wj3s08n_r8_MU",
      authDomain: "ios-calculator-vr46.firebaseapp.com",
      projectId: "ios-calculator-vr46",
      storageBucket: "ios-calculator-vr46.appspot.com",
      messagingSenderId: "613308798314",
      appId: "1:613308798314:web:73f42022f40374e4a24113",
      databaseURL: "https://ios-calculator-vr46-default-rtdb.firebaseio.com/" // Realtime Database URL
    };

    
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app); // Initialize Realtime Database

    const user = auth.currentUser;
    
    

    

    document.addEventListener("DOMContentLoaded", () => {
      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getDatabase(app);

      // Handle sign-out
      document.getElementById("sign-out").addEventListener("click", () => {
        signOut(auth)
          .then(() => {
            console.log("Sign-out successful.");
            window.location.href = "index.html";
          })
          .catch((error) => console.error("Sign-out error:", error.message));
      });

      // Handle authentication state changes
      onAuthStateChanged(auth, (user) => {
        if (!user) {
          console.log("No user signed in. Redirecting to index.html...");
          window.location.href = "index.html";
        } else {
          console.log("User is signed in:", user.email, user.displayName);
          document.getElementById("display-name").textContent="Hi, " + user.displayName;
          loadHistory(); // Load user history
        }
      });

      // Save history function
      async function saveHistoryToRealtimeDatabase(calculation) {
        const user = auth.currentUser;
        if (user) {
          const userHistoryRef = ref(db, 'history/' + user.uid);
          const newHistoryRef = push(userHistoryRef);
          try {
            await set(newHistoryRef, {
              calculation: calculation,
              timestamp: new Date().toISOString()
            });
            console.log("History saved successfully!");
          } catch (error) {
            console.error("Error saving history:", error);
          }
        } else {
          console.error("No user signed in.");
        }
      }

      // Load history function
      async function loadHistory() {
        const user = auth.currentUser;
        if (user) {
          const userHistoryRef = ref(db, 'history/' + user.uid);
          try {
            const snapshot = await get(userHistoryRef);
            if (snapshot.exists()) {
              const history = Object.values(snapshot.val());
              updateHistoryUI(history);
            } else {
              console.log("No history found.");
            }
          } catch (error) {
            console.error("Error loading history:", error);
          }
        } else {
          console.error("No user signed in.");
        }
      }

      // Update history UI
      function updateHistoryUI(history) {
        const historyList = document.getElementById("history-list");
        historyList.innerHTML = "";
        history.forEach(entry => {
          const li = document.createElement("li");
          const timestamp = new Date(entry.timestamp);
          const formattedTimestamp = timestamp.toLocaleString();
          li.textContent = `${entry.calculation} (calculated on: ${formattedTimestamp})`;
          historyList.appendChild(li);
        });
      }
    });

    // Clear user's history
    function clearHistory() {
      const user = auth.currentUser;
      if (user) {
        const userHistoryRef = ref(db, 'history/' + user.uid);
        set(userHistoryRef, null); // Clear history in database
        updateHistoryUI([]); // Update UI to show no history
      }
    }

    // Calculator Logic
    let screenContent = "";

    function appendToScreen(value) {
      screenContent += value;
      document.getElementById("screen").textContent = screenContent;
    }

    function clearScreen() {
      screenContent = "";
      document.getElementById("screen").textContent = "";
    }

    function calculate() {
      try {
        const result = eval(screenContent); // Unsafe eval, consider safer approach
        document.getElementById("screen").textContent = result;
        saveHistoryToRealtimeDatabase(screenContent + " = " + result); // Save result to Firebase
        screenContent = ""; // Clear screen after calculation
      } catch (e) {
        document.getElementById("screen").textContent = "Error";
      }
    }
  </script>
</head>

<body>
  <div class="hamburger" id="hamburger">&#9776;</div>
  <div id="sidebar" class="sidebar">
    <span id="close-btn" class="close-btn">&times;</span>
    <ul>
      <li id="display-name"></li>
      <li><a href="#" onclick="showHistory()">History</a></li>
      <li><a href="#" id="sign-out">Sign Out</a></li>
    </ul>
    <div id="history-container" class="history-container">
      <h3>Calculation History</h3>
      <ul id="history-list"></ul>
      <button onclick="clearHistory()">Clear History</button>
    </div>
  </div>

  <div class="calculator">
    <div class="screen" id="screen"></div>
    <div class="buttons">
      <!-- Calculator Buttons -->
      <button class="btn clear" onclick="clearScreen()">AC</button>
      <button class="btn clear" onclick="toggleSign()">+/-</button>
      <button class="btn clear" onclick="appendToScreen('%')">%</button>
      <button class="btn operator" onclick="appendToScreen('/')">/</button>
      <button class="btn" onclick="appendToScreen('7')">7</button>
      <button class="btn" onclick="appendToScreen('8')">8</button>
      <button class="btn" onclick="appendToScreen('9')">9</button>
      <button class="btn operator" onclick="appendToScreen('*')">*</button>
      <button class="btn" onclick="appendToScreen('4')">4</button>
      <button class="btn" onclick="appendToScreen('5')">5</button>
      <button class="btn" onclick="appendToScreen('6')">6</button>
      <button class="btn operator" onclick="appendToScreen('-')">-</button>
      <button class="btn" onclick="appendToScreen('1')">1</button>
      <button class="btn" onclick="appendToScreen('2')">2</button>
      <button class="btn" onclick="appendToScreen('3')">3</button>
      <button class="btn operator" onclick="appendToScreen('+')">+</button>
      <button class="btn" onclick="clearScreen()">C</button>
      <button class="btn" onclick="appendToScreen('0')">0</button>
      <button class="btn" onclick="appendToScreen('.')">.</button>
      <button class="btn operator" onclick="calculate()">=</button>
    </div>
  </div>
</body>

</html>